name: 'Activate SUSE Modules'
description: 'Activate SUSE modules (basesystem, PackageHub, legacy) on machines via SSH'

inputs:
  hosts_fqdn_list:
    description: 'Space-separated list of machine FQDNs to activate modules on'
    required: true
  ssh_username:
    description: 'SSH username'
    required: true
  ssh_private_key:
    description: 'SSH private key content'
    required: true
  connection_timeout:
    description: 'SSH connection timeout in seconds'
    required: false
    default: '60'

runs:
  using: 'composite'
  steps:
    - name: Convert hosts list to comma-separated format
      id: prepare-hosts
      shell: bash
      run: |
        HOSTS_FQDN_LIST="${{ inputs.hosts_fqdn_list }}"
        # Convert space-separated list to comma-separated
        HOSTS_CSV=$(echo $HOSTS_FQDN_LIST | tr ' ' ',')
        echo "hosts_csv=$HOSTS_CSV" >> $GITHUB_OUTPUT
        echo "Hosts to activate: $HOSTS_CSV"

    - name: Activate SUSE modules on machines
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ steps.prepare-hosts.outputs.hosts_csv }}
        username: ${{ inputs.ssh_username }}
        key: ${{ inputs.ssh_private_key }}
        timeout: 1m
        command_timeout: 1m
        script: |
          set -e

          source /etc/os-release

          echo "Detected OS VERSION_ID: $VERSION_ID"

          # Skip SLES 16 machines
          if [[ "$VERSION_ID" == 16* ]]; then
            exit 0
          fi

          SP=$(echo "$VERSION_ID" | cut -d'.' -f2)

          if [ -z "$SP" ]; then
            exit 1
          fi

          sudo SUSEConnect -p sle-module-basesystem/15.$SP/x86_64
          sudo SUSEConnect -p PackageHub/15.$SP/x86_64

          if [ "$SP" -eq 6 ]; then
            sudo SUSEConnect -p sle-module-legacy/15.$SP/x86_64
          fi