name: 'Generate Ansible Inventory'
description: 'Generate Ansible inventory file on control nodes with their matching target node'

inputs:
  hosts_fqdn_csv:
    description: 'Comma-separated list of machine FQDNs'
    required: true
  ssh_username:
    description: 'SSH username'
    required: true
  ssh_private_key:
    description: 'SSH private key content'
    required: true
  web_admin_password:
    description: 'Trento web admin password'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Generate Ansible inventory on control nodes
      uses: appleboy/ssh-action@v1.2.4
      env:
        SSH_USERNAME: ${{ inputs.ssh_username }}
        SSH_PRIVATE_KEY: ${{ inputs.ssh_private_key }}
        WEB_ADMIN_PASSWORD: ${{ inputs.web_admin_password }}
      with:
        host: ${{ inputs.hosts_fqdn_csv }}
        username: ${{ inputs.ssh_username }}
        key: ${{ inputs.ssh_private_key }}
        envs: SSH_USERNAME,SSH_PRIVATE_KEY,WEB_ADMIN_PASSWORD
        script: |
          set -e

          # Get current hostname (short name, e.g., control15sp6rpm)
          CURRENT_HOSTNAME=$(hostname -s)

          # Only run on control nodes
          if [[ "$CURRENT_HOSTNAME" != *control* ]]; then
            exit 0
          fi

          # Construct Azure public FQDN from short hostname
          AZURE_REGION="westeurope"
          CURRENT_FQDN="${CURRENT_HOSTNAME}.${AZURE_REGION}.cloudapp.azure.com"

          # Derive target FQDN by replacing 'control' with 'target'
          TARGET_FQDN="${CURRENT_FQDN/control/target}"

          # Setup SSH private key for Ansible to connect to target nodes
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Generate SSL certificate for nginx
          CERTS_DIR="/etc/ssl/trento"
          sudo mkdir -p "$CERTS_DIR"
          sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout "$CERTS_DIR/trento.key" -out "$CERTS_DIR/trento.crt" \
            -subj "/CN=${TARGET_FQDN}" -addext "subjectAltName=DNS:${TARGET_FQDN}"

          # Create Ansible inventory directory if it doesn't exist
          sudo mkdir -p /etc/ansible

          # Generate the inventory file
          sudo tee /etc/ansible/trento-inventory.yml > /dev/null << EOF
          all:
            children:
              trento_hosts:
                vars:
                  # ansible_python_interpreter: "/usr/bin/python3.11"
                  provision_prometheus: false
                  provision_proxy: true
                  web_postgres_password: "postgres"
                  wanda_postgres_password: "postgres"
                  rabbitmq_password: "admin"
                  web_admin_password: "$WEB_ADMIN_PASSWORD"
                  web_port: 4000
                  wanda_port: 4001
                  trento_server_name: "{{ inventory_hostname }}"
                  nginx_vhost_filename: "{{ inventory_hostname }}"
                  nginx_ssl_cert: "$CERTS_DIR/trento.crt"
                  nginx_ssl_key: "$CERTS_DIR/trento.key"
                hosts:
                  ${TARGET_FQDN}:
                    ansible_user: $SSH_USERNAME
              trento_server:
                children:
                  trento_hosts: {}
              postgres_hosts:
                children:
                  trento_hosts: {}
              rabbitmq_hosts:
                children:
                  trento_hosts: {}
          EOF
