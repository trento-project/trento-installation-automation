name: 'Run Ansible Trento Playbook'
description: 'Run the Trento playbook on control nodes'

inputs:
  hosts_fqdn_csv:
    description: 'Comma-separated list of machine FQDNs'
    required: true
  ssh_username:
    description: 'SSH username'
    required: true
  ssh_private_key:
    description: 'SSH private key content'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Run Ansible Trento playbook on control nodes
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ inputs.hosts_fqdn_csv }}
        username: ${{ inputs.ssh_username }}
        key: ${{ inputs.ssh_private_key }}
        command_timeout: 30m
        script: |
          set -e

          CURRENT_HOSTNAME=$(hostname -s)

          # Only run on control nodes
          if [[ "$CURRENT_HOSTNAME" != *control* ]]; then
            exit 0
          fi

          INVENTORY_FILE="/etc/ansible/trento-inventory.yml"

          if [ ! -f "$INVENTORY_FILE" ]; then
            echo "ERROR: Inventory file not found at $INVENTORY_FILE"
            exit 1
          fi

          # Run Ansible playbook using FQCN (collection installed via trento-ansible package)
          ansible-playbook -i "$INVENTORY_FILE" suse.trento.site
