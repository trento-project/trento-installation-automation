name: 'Run Ansible Trento Playbook'
description: 'Setup Python venv with compatible Ansible version and run the Trento playbook on control nodes'

inputs:
  hosts_fqdn_csv:
    description: 'Comma-separated list of machine FQDNs'
    required: true
  ssh_username:
    description: 'SSH username'
    required: true
  ssh_private_key:
    description: 'SSH private key content'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Run Ansible Trento playbook on control nodes
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ inputs.hosts_fqdn_csv }}
        username: ${{ inputs.ssh_username }}
        key: ${{ inputs.ssh_private_key }}
        command_timeout: 30m
        script: |
          set -e

          CURRENT_HOSTNAME=$(hostname -s)

          # Only run on control nodes
          if [[ "$CURRENT_HOSTNAME" != *control* ]]; then
            exit 0
          fi

          source /etc/os-release

          # Python/Ansible Compatibility Matrix (https://github.com/trento-project/ansible#support-matrix)
          # SLES 15 SP4/SP5: Ansible 9 (ansible-core 2.16.*) with Python 3.11
          # SLES 15 SP6/SP7: Ansible 11 (ansible-core 2.18.*) with Python 3.11
          # Note: ansible-core 2.16+ requires Python 3.10+, so we use Python 3.11 for all versions
          case "$VERSION_ID" in
            15.4|15.5)
              PYTHON_EXEC="/usr/bin/python3.11"
              ANSIBLE_CORE_VERSION="2.16.*"
              ;;
            15.6|15.7)
              PYTHON_EXEC="/usr/bin/python3.11"
              ANSIBLE_CORE_VERSION="2.18.*"
              ;;
            *)
              echo "ERROR: Unsupported SLES version: $VERSION_ID"
              exit 1
              ;;
          esac

          VENV_PATH="$HOME/.venv-ansible"
          INVENTORY_FILE="/etc/ansible/trento-inventory.yml"

          if [ ! -f "$INVENTORY_FILE" ]; then
            echo "ERROR: Inventory file not found at $INVENTORY_FILE"
            exit 1
          fi

          # Setup Python virtual environment
          if [ ! -f "$VENV_PATH/bin/ansible-playbook" ]; then
            "$PYTHON_EXEC" -m venv "$VENV_PATH"
            source "$VENV_PATH/bin/activate"
            pip install --upgrade pip
            pip install "ansible-core==$ANSIBLE_CORE_VERSION"
            # Install required collection dependencies
            "$VENV_PATH/bin/ansible-galaxy" collection install community.general
          else
            source "$VENV_PATH/bin/activate"
          fi

          # Run Ansible playbook using FQCN (collection installed via trento-ansible package)
          "$VENV_PATH/bin/ansible-playbook" -i "$INVENTORY_FILE" suse.trento.site
