runs:
  using: 'composite'
  steps:
    - name: Run Ansible Trento playbook on control nodes
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: control15sp4rpm.westeurope.cloudapp.azure.com
        username: ${{ inputs.ssh_username }}
        key: ${{ inputs.ssh_private_key }}
        command_timeout: 30m
        script: |
            set -e

            CURRENT_HOSTNAME=$(hostname -s)
            if [[ "$CURRENT_HOSTNAME" != *control* ]]; then
              exit 0
            fi

            INVENTORY_FILE="/etc/ansible/trento-inventory.yml"

            if [[ "$CURRENT_HOSTNAME" == *sp4* ]]; then          
              echo "Standardizing environment: Ansible 2.9 + Essential Collections"
              
              # 1. Downgrade engine
              sudo zypper --non-interactive install --oldpackage --allow-vendor-change --force-resolution "ansible<3" -ansible-core
              
              # 2. Install ALL collections Trento might need
              sudo mkdir -p /usr/share/ansible/collections
              # The 'Trento Starter Pack' for Ansible 2.9
              sudo ansible-galaxy collection install \
                community.general \
                community.postgresql \
                community.rabbitmq \
                community.crypto \
                ansible.posix \
                -p /usr/share/ansible/collections --force
            fi

            export ANSIBLE_COLLECTIONS_PATHS=/usr/share/ansible/collections
            export ANSIBLE_ROLES_PATH=/usr/share/ansible/roles

            ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook \
              -i "$INVENTORY_FILE" \
              /usr/share/ansible/collections/ansible_collections/suse/trento/playbooks/site.yml