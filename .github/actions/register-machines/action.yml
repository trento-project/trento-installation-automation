name: 'Register Machines with SUSEConnect'
description: 'SSH into VMs and register them with SUSEConnect'

inputs:
  private_ssh_key_content:
    description: 'SSH private key content for VM access'
    required: true
  suse_registration_code:
    description: 'SUSE registration code'
    required: true
  suse_registration_email:
    description: 'SUSE registration email'
    required: true
  azure_resource_group:
    description: 'Azure resource group name'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Register machines
      shell: bash
      run: |
        set -euo pipefail

        # Setup SSH key
        SSH_KEY_PATH="${HOME}/.ssh/id_ed25519"
        mkdir -p "${HOME}/.ssh"
        echo "${{ inputs.private_ssh_key_content }}" > "${SSH_KEY_PATH}"
        chmod 600 "${SSH_KEY_PATH}"

        # Setup logs directory
        LOGS_DIR="machine-logs"
        mkdir -p "${LOGS_DIR}"
        echo "ğŸ“ Created logs directory: ${LOGS_DIR}"

        # Query Azure location from resource group
        echo "ğŸ” Querying location from resource group: ${{ inputs.azure_resource_group }}"
        AZURE_LOCATION=$(az group show --name "${{ inputs.azure_resource_group }}" --query location -o tsv)
        if [ -z "$AZURE_LOCATION" ]; then
          echo "âŒ Error: Could not retrieve location from resource group ${{ inputs.azure_resource_group }}"
          exit 1
        fi
        echo "âœ… Using location: $AZURE_LOCATION"

        # Configuration
        DOMAIN_SUFFIX="${AZURE_LOCATION}.cloudapp.azure.com"
        USER="cloudadmin"

        # Function to wait for SSH and register machine
        register_machine() {
          local FQDN=$1
          local VM_NAME=$2
          local LOG_FILE="${LOGS_DIR}/${VM_NAME}.log"

          echo "ğŸ› ï¸  Registering $VM_NAME at $FQDN" | tee -a "$LOG_FILE"

          # Wait for SSH port availability
          echo "â³ Waiting for SSH port (22) on $FQDN..." | tee -a "$LOG_FILE"
          local max_attempts=20
          local attempt=1
          while ! nc -z -w 5 "$FQDN" 22; do
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "âŒ SSH port not reachable after $attempt attempts on $FQDN" | tee -a "$LOG_FILE"
              return 1
            fi
            echo "   Attempt $attempt: Port 22 still closed, waiting 10s..." | tee -a "$LOG_FILE"
            attempt=$((attempt+1))
            sleep 10
          done
          echo "âœ… SSH port is available on $FQDN" | tee -a "$LOG_FILE"

          # Wait for SSH login readiness
          echo "â³ Waiting for SSH login to be permitted on $FQDN..." | tee -a "$LOG_FILE"
          local login_max_attempts=15
          local login_attempt=1
          while ! ssh -o StrictHostKeyChecking=accept-new -i "$SSH_KEY_PATH" "$USER@$FQDN" true 2>/dev/null; do
            if [ "$login_attempt" -ge "$login_max_attempts" ]; then
              echo "âŒ SSH login not permitted after $login_attempt attempts on $FQDN" | tee -a "$LOG_FILE"
              return 1
            fi
            echo "   Login attempt $login_attempt: Still booting, waiting 15s..." | tee -a "$LOG_FILE"
            login_attempt=$((login_attempt+1))
            sleep 15
          done
          echo "âœ… SSH login is now permitted on $FQDN" | tee -a "$LOG_FILE"

          # Register with SUSEConnect
          echo "ğŸ”‘ Registering $VM_NAME with SUSEConnect..." | tee -a "$LOG_FILE"
          if ssh -o StrictHostKeyChecking=accept-new -i "$SSH_KEY_PATH" "$USER@$FQDN" \
            "sudo SUSEConnect -r '${{ inputs.suse_registration_code }}' -e '${{ inputs.suse_registration_email }}'" 2>&1 | tee -a "$LOG_FILE"; then
            echo "âœ… Successfully registered $VM_NAME" | tee -a "$LOG_FILE"
            return 0
          else
            echo "âš ï¸  Registration failed or already completed for $VM_NAME" | tee -a "$LOG_FILE"
            return 0
          fi
        }

        # Read machines from CSV and register in parallel
        echo "ğŸš€ Starting machine registration..."
        PIDS=()

        while IFS=, read -r prefix slesVersion spVersion suffix || [ -n "$prefix" ]; do
          # Skip header line
          if [[ "$prefix" == "prefix" ]]; then
            continue
          fi

          # Normalize and clean CSV data
          prefix=$(echo "$prefix" | tr -d '\r' | xargs)
          slesVersion=$(echo "$slesVersion" | tr -d '\r' | xargs)
          spVersion=$(echo "$spVersion" | tr -d '\r' | xargs)
          suffix=$(echo "$suffix" | tr -d '\r' | xargs)

          # Skip empty lines
          if [ -z "$prefix" ] && [ -z "$slesVersion" ] && [ -z "$spVersion" ] && [ -z "$suffix" ]; then
            continue
          fi

          # Construct FQDN
          VM_NAME="${prefix}${slesVersion}sp${spVersion}${suffix}"
          FQDN="${VM_NAME}.${DOMAIN_SUFFIX}"

          # Launch registration in background
          register_machine "$FQDN" "$VM_NAME" &
          PIDS+=($!)
          echo "  > Launched registration for $VM_NAME"
        done < .machines.conf.csv

        # Wait for all registrations to complete
        ERROR_COUNT=0
        for pid in "${PIDS[@]}"; do
          if ! wait "$pid"; then
            ERROR_COUNT=$((ERROR_COUNT+1))
          fi
        done

        # Report results
        if [ "$ERROR_COUNT" -ne 0 ]; then
          echo "ğŸš¨ $ERROR_COUNT machine(s) failed during registration"
          exit 1
        fi

        echo "âœ… All machines registered successfully"

        # Log summary
        if [ -d "${LOGS_DIR}" ] && [ "$(ls -A ${LOGS_DIR})" ]; then
          LOG_COUNT=$(ls -1 "${LOGS_DIR}"/*.log 2>/dev/null | wc -l)
          echo "ğŸ“ Generated ${LOG_COUNT} machine log file(s) in ${LOGS_DIR}/"
        fi
